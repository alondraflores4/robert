<?php
session_start();
?>
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Heebo:400,700|Oxygen:700" rel="stylesheet">
  <link rel="shortcut icon" href="../ico/sound.png" type="image/x-icon">
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/cards.css">
  <link rel="stylesheet" href="../dist/css/style.css">
  <link rel="stylesheet" href="../css/app.css">
  <link rel="stylesheet" href="../css/txt.css">
  <style>
    img {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      transition: transform 0.5s ease-in-out;
    }

    .containers {
      background-image: url('../img/1.webp');

      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      max-inline-size: 50%;
    }

    .img-circle {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: white;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
  <title>Robert</title>
</head>

<body class="mt-0">
  <h1 class="text-center">Intelligent House</h1>
  <h3 class="text-description text-center mb-5">
    Para poder interactuar con la Intelligent House, es necesario decir alguna de los siguientes prompts.
  </h3>
  <h5 class="text-center mb-5">Para poder activar el micrófono es necesario dar clic en cualquier parte de la pantalla después de una orden.</h5>
  <div class="container">
    <div class="filler-text">
      <ul>
        <li>Robert enciende la luz de la recámara</li>
        <li>Robert enciende la luz de la sala</li>
        <li>Robert enciende las luces del jardín</li>
        <li>Robert enciende el ventilador</li>
        <li>Robert abre las cortinas</li>
        <li>Robert activa la alarma de la casa</li>
        <li>Robert enciende las cámaras de seguridad</li>
      </ul>
      <ul>

      </ul>
      <ul>
        <li>Robert apaga la luz de la recámara</li>
        <li>Robert apaga la luz de la sala</li>
        <li>Robert apaga las luces del jardín</li>
        <li>Robert apaga el ventilador</li>
        <li>Robert cierra las cortinas</li>
        <li>Robert apaga la alarma de la casa</li>
        <li>Robert apaga las cámaras de seguridad</li>
      </ul>
    </div>
  </div>
  <!-- <?php require '../components/nav.php'; ?>
  <br>
  <?php require '../view/instructions.php'; ?> -->
  <div class="container containers mt-5">
    <div class="casa">
      <div class="cards">
        <div class="card red" id="recamara">

          <div class="img" id="img-recamara">
            <img src="../img/idea-bulb.png" alt="Recámara" width="100px" height="auto">
          </div>
          <span class="etiqueta">Recámara</span>

        </div>

        <div class="card blue" id="cortina">

          <div class="img" id="img-cortina">
            <img src="../img/cortina-off.png" alt="Sala" width="100px" height="auto">
          </div>
          <span class="etiqueta">Cortinas</span>

        </div>
        <div class="card green" id="ventilador">

          <div class="img" id="img-ventilador">
            <img src="../img/ventilador-off.png" alt="Recámara" width="100px" height="auto">
          </div>
          <span class="etiqueta">Ventilador</span>

        </div>
        <div class="card red" id="camara">
          <div class="img-circle mx-auto mt-5">
            <div id="img-camara">
              <img src="../img/camara-off.png" alt="Sala" width="100px" height="auto">
            </div>
          </div>
          <span class="etiqueta text-center">Cámara de Seguridad</span>
        </div>
        <div class="card red" id="camara">
          <div class="img-circle mx-auto mt-5">
            <div id="img-camara">
              <img src="../img/camara-off.png" alt="Sala" width="100px" height="auto">
            </div>
          </div>
          <span class="etiqueta text-center">Cámara de Seguridad</span>
        </div>
        <div class="card green" id="patio">


          <span class="etiqueta"></span>

        </div>
        <div class="card red" id="recamara">


          <span class="etiqueta"></span>

        </div>
        <div class="card blue" id="sala">

          <div class="img" id="img-sala">
            <img src="../img/sala-off-1.png" alt="Sala" width="100px" height="auto">
          </div>
          <span class="etiqueta">Sala</span>

        </div>

        <div class="card green" id="jardin">
          <div class="card-body">
            <div class="row">
              <div class="col-12 img" id="img-jardin">
                <img src="../img/jardin-off.png" alt="" width="50px" height="auto" />
              </div>
              <div class="col-12 img" id="img-jardin">
                <img src="../img/jardin-off.png" alt="" width="50px" height="auto" />
              </div>
              <div class="col-12 img" id="img-jardin">
                <img src="../img/jardin-off.png" alt="" width="50px" height="auto" />
              </div>
              <div class="col-12 img" id="img-jardin">
                <img src="../img/jardin-off.png" alt="" width="50px" height="auto" />
              </div>
              <div class="col-12 img" id="img-jardin">
                <img src="../img/jardin-off.png" alt="" width="50px" height="auto" />
              </div>
            </div>
            <span class="etiqueta">Jardín</span>
          </div>
        </div>

        <div class="card red text-left mt-4 ml-7 p-3 align-items-start" id="cortina">
          <div class="card-body">
            <div class="row">
              <div class="img" id="cortina">
                <img src="../img/cortina-off.png" alt="Sala" width="100px" height="auto">
              </div>
            </div>
            <span class="etiqueta align-middle">Cortinas</span>
          </div>
        </div>

        <div class="card blue" id="cortina">

          <div class="img" id="img-cortina">
            <img src="../img/cortina-off.png" alt="Sala" width="100px" height="auto">
          </div>
          <span class="etiqueta">Cortinas</span>

        </div>
        <div class="card green" id="alarma">
          <div class="img" id="img-alarma">
            <img src="../img/alarma-off.png" width="100px" height="auto">
          </div>
          <span class="etiqueta">Alarma</span>

        </div>


        <div class="card red" id="camara">
          <div class="img-circle mx-auto mt-5">
            <div id="img-camara">
              <img src="../img/camara-off.png" alt="Sala" width="100px" height="auto">
            </div>
          </div>
          <span class="etiqueta text-center">Cámara de Seguridad</span>
        </div>
      </div>
    </div>
    <div class="texts txt"></div>
  </div>
  <br><br><br><br><br>
  <?php require '../components/footer.php'; ?>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.umd.min.js"></script>
  <script>
    /*document.addEventListener("DOMContentLoaded", () => {
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      let recognition;
      let audio;
      let audioEnabled = false;

      function initializeRecognition() {
        recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.interimResults = true;

        recognition.addEventListener("result", (e) => {
          const text = Array.from(e.results)
            .map((result) => result[0])
            .map((result) => result.transcript)
            .join("");

          if (e.results[0].isFinal) {
            if (text.includes("Robert") && audioEnabled) {
              audio = new Audio('../sound/robert.mp3');
              audio.play().catch(error => console.error('Error al reproducir el sonido:', error));
            }
            try {
              let command = '';
              if (text.includes("mueve el árbol")) {
                command = 'mueve el árbol';
                console.log("Comando 'mueve el árbol' ejecutado correctamente.");
              } else if (text.includes("enciende la luz de la recámara")) {
                const recamara = document.getElementById('recamara').querySelector('img');
                recamara.src = '../img/idea-bulb-recamara.png';
                command = 'enciende la luz de la recámara';
                console.log("Comando 'enciende la luz de la recámara' ejecutado correctamente.");
              } else if (text.includes("apaga la luz de la recámara")) {
                const recamara = document.getElementById('recamara').querySelector('img');
                recamara.src = '../img/idea-bulb.png';
                command = 'apaga la luz de la recámara';
                console.log("Comando 'apaga la luz de la recámara' ejecutado correctamente.");
              } else if (text.includes("enciende la luz de la sala")) {
                const sala = document.getElementById('sala').querySelector('img');
                sala.src = '../img/sala-on.png';
                command = 'enciende la luz de la sala';
                console.log("Comando 'enciende la luz de la sala' ejecutado correctamente.");
              } else if (text.includes("apaga la luz de la sala")) {
                const sala = document.getElementById('sala').querySelector('img');
                sala.src = '../img/sala-off-1.png';
                command = 'apaga la luz de la sala';
                console.log("Comando 'apaga la luz de la sala' ejecutado correctamente.");
              } else if (text.includes("enciende las luces del jardín")) {
                const lucesJardin = document.getElementById('jardin').querySelectorAll('img');
                lucesJardin.forEach(img => {
                  img.src = '../img/jardin-on.png';
                });
                command = 'enciende las luces del jardín';
                console.log("Comando 'enciende las luces del jardín' ejecutado correctamente.");
              } else if (text.includes("apaga las luces del jardín")) {
                const lucesJardin = document.getElementById('jardin').querySelectorAll('img');
                lucesJardin.forEach(img => {
                  img.src = '../img/jardin-off.png';
                });
                command = 'apaga las luces del jardín';
                console.log("Comando 'apaga las luces del jardín' ejecutado correctamente.");
              } else if (text.includes("enciende el ventilador")) {
                const ventilador = document.getElementById('ventilador').querySelector('img');
                ventilador.src = '../img/ventilador-on.png';
                ventilador.style.animation = 'rotateFan 2s linear infinite';
                command = 'enciende el ventilador';
                console.log("Comando 'enciende el ventilador' ejecutado correctamente.");
              } else if (text.includes("apaga el ventilador")) {
                const ventilador = document.getElementById('ventilador').querySelector('img');
                ventilador.src = '../img/ventilador-off.png';
                ventilador.style.animation = 'none';
                command = 'apaga el ventilador';
                console.log("Comando 'apaga el ventilador' ejecutado correctamente.");
              } else if (text.includes("abre las cortinas")) {
                const cortinas = document.querySelectorAll('.card[id="cortina"] img');
                cortinas.forEach(img => {
                  img.src = '../img/cortina-off.png';
                });
                command = 'abre las cortinas';
                console.log("Comando 'abre las cortinas' ejecutado correctamente.");
              } else if (text.includes("cierra las cortinas")) {
                const cortinas = document.querySelectorAll('.card[id="cortina"] img');
                cortinas.forEach(img => {
                  img.src = '../img/cortina-on.png';
                });
                command = 'cierra las cortinas';
                console.log("Comando 'cierra las cortinas' ejecutado correctamente.");
              } else if (text.includes("activa la alarma de la casa")) {
                const alarma = document.getElementById('alarma').querySelector('img');
                alarma.src = '../img/alarma-on.png';
                command = 'activa la alarma de la casa';
                audio = new Audio('../sound/alarm.mp3');
                audio.play();
                console.log("Comando 'activa la alarma de la casa' ejecutado correctamente.");
              } else if (text.includes("apaga la alarma de la casa")) {
                const alarma = document.getElementById('alarma').querySelector('img');
                alarma.src = '../img/alarma-off.png';

                if (audio && !audio.paused) {
                  audio.pause();
                  audio.currentTime = 0;
                }
                command = 'apaga la alarma de la casa';
                console.log("Comando 'apaga la alarma de la casa' ejecutado correctamente.");
              } else if (text.includes("enciende las cámaras de seguridad")) {
                const camaras = document.querySelectorAll('.card[id="camara"] img');
                camaras.forEach(img => {
                  img.src = '../img/camara-on.png';
                });
                command = 'enciende las cámaras de seguridad';
                console.log("Comando 'enciende las cámaras de seguridad' ejecutado correctamente.");
              } else if (text.includes("apaga las cámaras de seguridad")) {
                const camaras = document.querySelectorAll('.card[id="camara"] img');
                camaras.forEach(img => {
                  img.src = '../img/camara-off.png';
                });
                command = 'apaga las cámaras de seguridad';
                console.log("Comando 'apaga las cámaras de seguridad' ejecutado correctamente.");
              } else {
                console.log("Comando no reconocido:", text);
              }
              console.log("Comando enviado al servidor:", command);
              axios.post('../backend/guardar_comando.php', {
                  command: command
                })
                .then(response => console.log(response))
                .catch(error => console.error(error));
            } catch (error) {
              console.error('Error al ejecutar el comando:', error);
            }
          }
        });
      }

      function startRecognition() {
        if (!recognition) {
          initializeRecognition();
        }
        recognition.start();
      }

      function stopRecognition() {
        if (recognition) {
          recognition.stop();
        }
      }

      document.body.addEventListener("click", () => {
        audioEnabled = true;
        startRecognition(); 
      });

    
      startRecognition();
    });*/




    document.addEventListener("DOMContentLoaded", () => {
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let audio;
    let audioEnabled = false;

    function enviarOrdenAMockAPI(orden, fechaHora) {
      //API que Inyecta los valores
        const url = `https://66306747c92f351c03d9bbbc.mockapi.io/robert`;

        const data = {
            "Orden": orden,
            "Usuario": "admin",
            "Fecha-Hora": fechaHora
        };

        return fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Error al enviar orden al MOCKAPI');
            }
        })
        .catch(error => {
            console.error('Error al enviar orden al MOCKAPI:', error);
            throw error;
        });
    }

    function obtenerFechaHoraActual() {
        const ahora = new Date();
        const options = { timeZone: 'America/Mexico_City' };
        const formatter = new Intl.DateTimeFormat('es-MX', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            timeZone: options.timeZone
        });
        const fechaHora = formatter.format(ahora);
        return fechaHora.replace(/\//g, '-').replace(',', '');
    }

    function initializeRecognition() {
        recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.interimResults = true;

        recognition.addEventListener("result", (e) => {
            const text = Array.from(e.results)
                .map((result) => result[0])
                .map((result) => result.transcript)
                .join("");

            if (e.results[0].isFinal) {
                let command = '';
                if (text.includes("mueve el árbol")) {
                    command = 'mueve el árbol';
                    console.log("Comando 'mueve el árbol' ejecutado correctamente.");
                } else if (text.includes("enciende la luz de la recámara")) {
                    const recamara = document.getElementById('recamara').querySelector('img');
                    recamara.src = '../img/idea-bulb-recamara.png';
                    command = 'enciende la luz de la recámara';
                    console.log("Comando 'enciende la luz de la recámara' ejecutado correctamente.");
                } else if (text.includes("apaga la luz de la recámara")) {
                    const recamara = document.getElementById('recamara').querySelector('img');
                    recamara.src = '../img/idea-bulb.png';
                    command = 'apaga la luz de la recámara';
                    console.log("Comando 'apaga la luz de la recámara' ejecutado correctamente.");
                } else if (text.includes("enciende la luz de la sala")) {
                    const sala = document.getElementById('sala').querySelector('img');
                    sala.src = '../img/sala-on.png';
                    command = 'enciende la luz de la sala';
                    console.log("Comando 'enciende la luz de la sala' ejecutado correctamente.");
                } else if (text.includes("apaga la luz de la sala")) {
                    const sala = document.getElementById('sala').querySelector('img');
                    sala.src = '../img/sala-off-1.png';
                    command = 'apaga la luz de la sala';
                    console.log("Comando 'apaga la luz de la sala' ejecutado correctamente.");
                } else if (text.includes("enciende las luces del jardín")) {
                    const lucesJardin = document.getElementById('jardin').querySelectorAll('img');
                    lucesJardin.forEach(img => {
                        img.src = '../img/jardin-on.png';
                    });
                    command = 'enciende las luces del jardín';
                    console.log("Comando 'enciende las luces del jardín' ejecutado correctamente.");
                } else if (text.includes("apaga las luces del jardín")) {
                    const lucesJardin = document.getElementById('jardin').querySelectorAll('img');
                    lucesJardin.forEach(img => {
                        img.src = '../img/jardin-off.png';
                    });
                    command = 'apaga las luces del jardín';
                    console.log("Comando 'apaga las luces del jardín' ejecutado correctamente.");
                } else if (text.includes("enciende el ventilador")) {
                    const ventilador = document.getElementById('ventilador').querySelector('img');
                    ventilador.src = '../img/ventilador-on.png';
                    ventilador.style.animation = 'rotateFan 2s linear infinite';
                    command = 'enciende el ventilador';
                    console.log("Comando 'enciende el ventilador' ejecutado correctamente.");
                } else if (text.includes("apaga el ventilador")) {
                    const ventilador = document.getElementById('ventilador').querySelector('img');
                    ventilador.src = '../img/ventilador-off.png';
                    ventilador.style.animation = 'none';
                    command = 'apaga el ventilador';
                    console.log("Comando 'apaga el ventilador' ejecutado correctamente.");
                } else if (text.includes("abre las cortinas")) {
                    const cortinas = document.querySelectorAll('.card[id="cortina"] img');
                    cortinas.forEach(img => {
                        img.src = '../img/cortina-off.png';
                    });
                    command = 'abre las cortinas';
                    console.log("Comando 'abre las cortinas' ejecutado correctamente.");
                } else if (text.includes("cierra las cortinas")) {
                    const cortinas = document.querySelectorAll('.card[id="cortina"] img');
                    cortinas.forEach(img => {
                        img.src = '../img/cortina-on.png';
                    });
                    command = 'cierra las cortinas';
                    console.log("Comando 'cierra las cortinas' ejecutado correctamente.");
                } else if (text.includes("activa la alarma de la casa")) {
                    const alarma = document.getElementById('alarma').querySelector('img');
                    alarma.src = '../img/alarma-on.png';
                    command = 'activa la alarma de la casa';
                    audio = new Audio('../sound/alarm.mp3');
                    audio.play();
                    console.log("Comando 'activa la alarma de la casa' ejecutado correctamente.");
                } else if (text.includes("apaga la alarma de la casa")) {
                    const alarma = document.getElementById('alarma').querySelector('img');
                    alarma.src = '../img/alarma-off.png';

                    if (audio && !audio.paused) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                    command = 'apaga la alarma de la casa';
                    console.log("Comando 'apaga la alarma de la casa' ejecutado correctamente.");
                } else if (text.includes("enciende las cámaras de seguridad")) {
                    const camaras = document.querySelectorAll('.card[id="camara"] img');
                    camaras.forEach(img => {
                        img.src = '../img/camara-on.png';
                    });
                    command = 'enciende las cámaras de seguridad';
                    console.log("Comando 'enciende las cámaras de seguridad' ejecutado correctamente.");
                } else if (text.includes("apaga las cámaras de seguridad")) {
                    const camaras = document.querySelectorAll('.card[id="camara"] img');
                    camaras.forEach(img => {
                        img.src = '../img/camara-off.png';
                    });
                    command = 'apaga las cámaras de seguridad';
                    console.log("Comando 'apaga las cámaras de seguridad' ejecutado correctamente.");
                } else {
                    console.log("Comando no reconocido:", text);
                }

                if (audioEnabled && text.includes("Robert")) {
                    audio = new Audio('../sound/robert.mp3');
                    audio.play().catch(error => console.error('Error al reproducir el sonido:', error));
                }

                if (command !== '') {
                    console.log("Comando almacenado en MockAPI:", command);
                    const fechaHoraActual = obtenerFechaHoraActual();
                    const dataToMockAPI = {
                        "Orden": command,
                        "Usuario": "admin",
                        "Fecha-Hora": fechaHoraActual
                    };
                    enviarOrdenAMockAPI(dataToMockAPI.Orden, dataToMockAPI['Fecha-Hora']);
                }
            }
        });
    }

    function startRecognition() {
        if (!recognition) {
            initializeRecognition();
        }
        recognition.start();
    }

    function stopRecognition() {
        if (recognition) {
            recognition.stop();
        }
    }

    document.body.addEventListener("click", () => {
        audioEnabled = true;
        startRecognition();
    });

    startRecognition();
});


  </script>
</body>

</html>